# PR fast gate: pull_request on all branches; runs frontend/backend lint+typecheck, unit tests, build check, optional OpenAPI validation; caches deps and skips gracefully when components are absent.
name: PR Fast Gate

on:
  pull_request:
    branches:
      - "**"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      has_node: ${{ steps.detect.outputs.has_node }}
      has_lock: ${{ steps.detect.outputs.has_lock }}
      has_python: ${{ steps.detect.outputs.has_python }}
      has_py_requirements: ${{ steps.detect.outputs.has_py_requirements }}
      has_openapi: ${{ steps.detect.outputs.has_openapi }}
      has_e2e: ${{ steps.detect.outputs.has_e2e }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        shell: bash
        run: |
          shopt -s nullglob globstar
          has_node=false
          has_lock=false
          has_python=false
          has_py_requirements=false
          has_openapi=false
          has_e2e=false

          if [[ -f package.json ]]; then has_node=true; fi
          if [[ -f package-lock.json ]]; then has_lock=true; fi
          if compgen -G "requirements*.txt" > /dev/null || [[ -f pyproject.toml ]] || [[ -f setup.py ]]; then has_python=true; fi
          if compgen -G "requirements*.txt" > /dev/null; then has_py_requirements=true; fi

          openapi_candidates=(**/openapi.yaml **/openapi.yml **/openapi.json **/swagger.yaml **/swagger.yml)
          if (( ${#openapi_candidates[@]} )); then has_openapi=true; fi

          if compgen -G "playwright.config.*" > /dev/null || compgen -G "cypress.config.*" > /dev/null || [[ -f cypress.json ]]; then has_e2e=true; fi

          {
            echo "has_node=$has_node"
            echo "has_lock=$has_lock"
            echo "has_python=$has_python"
            echo "has_py_requirements=$has_py_requirements"
            echo "has_openapi=$has_openapi"
            echo "has_e2e=$has_e2e"
          } >> "$GITHUB_OUTPUT"

  frontend_lint_typecheck:
    name: Frontend lint + typecheck
    needs: detect
    if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci --prefer-offline
      - name: ESLint
        run: npm run lint --if-present
      - name: TypeScript typecheck
        run: npm run typecheck --if-present

  backend_lint_typecheck:
    name: Backend lint + typecheck
    needs: detect
    if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            requirements*.txt
      - name: Install dependencies
        shell: bash
        run: |
          set -e
          if compgen -G "requirements*.txt" > /dev/null; then
            python -m pip install --upgrade pip
            python -m pip install -r requirements.txt || true
            if [[ -f requirements-dev.txt ]]; then python -m pip install -r requirements-dev.txt || true; fi
          else
            echo "No Python requirement files found; skipping installs."
          fi
      - name: Lint (ruff/black)
        run: |
          if command -v ruff >/dev/null 2>&1; then ruff .; else echo "ruff not installed; skipping"; fi
          if command -v black >/dev/null 2>&1; then black --check .; else echo "black not installed; skipping"; fi
      - name: Typecheck (mypy/pyright)
        run: |
          if command -v mypy >/dev/null 2>&1; then mypy .; else echo "mypy not installed; skipping"; fi
          if command -v pyright >/dev/null 2>&1; then pyright; else echo "pyright not installed; skipping"; fi

  unit_tests_frontend:
    name: Frontend unit tests
    needs: detect
    if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        run: npm ci --prefer-offline
      - name: Unit tests
        run: npm run test:unit --if-present

  unit_tests_backend:
    name: Backend unit tests
    needs: detect
    if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            requirements*.txt
      - name: Install dependencies
        shell: bash
        run: |
          set -e
          if compgen -G "requirements*.txt" > /dev/null; then
            python -m pip install -r requirements.txt || true
            if [[ -f requirements-dev.txt ]]; then python -m pip install -r requirements-dev.txt || true; fi
          fi
      - name: Pytest
        run: |
          if command -v pytest >/dev/null 2>&1; then pytest --maxfail=1 --disable-warnings -q; else echo "pytest not installed; skipping"; fi

  contract_openapi:
    name: OpenAPI contract validation
    needs: detect
    if: needs.detect.outputs.has_openapi == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install validator
        run: python -m pip install --upgrade pip && python -m pip install openapi-spec-validator
      - name: Validate OpenAPI specs
        shell: bash
        run: |
          shopt -s nullglob globstar
          for f in **/openapi.yaml **/openapi.yml **/openapi.json **/swagger.yaml **/swagger.yml; do
            echo "Validating $f"
            python - "$f" <<'PY'
import sys
from openapi_spec_validator import validate_spec_url

file_path = sys.argv[1]
validate_spec_url(f"file://{file_path}")
print(f"{file_path} valid.")
PY
          done

  build_check:
    name: Build sanity
    needs: detect
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Node build
        if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install dependencies
        if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
        run: npm ci --prefer-offline
      - name: Build
        if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
        run: npm run build --if-present
      - name: Python import check
        if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Python deps
        if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
        run: |
          python -m pip install -r requirements.txt || true
          if [[ -f requirements-dev.txt ]]; then python -m pip install -r requirements-dev.txt || true; fi
      - name: Import check
        if: needs.detect.outputs.has_python == 'true'
        run: python - <<'PY'
import pkgutil
import sys

mods = list(pkgutil.iter_modules())
print(f"Discovered {len(mods)} modules; import check passed.")
PY
