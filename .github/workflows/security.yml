# Security: pull_request + weekly schedule + manual; runs CodeQL, dependency audits (npm/pip), secret scan (gitleaks), container/fs scan (trivy), and SBOM (syft). Jobs skip when stacks are absent; fail on high/critical findings.
name: Security

on:
  pull_request:
  schedule:
    - cron: "0 2 * * 0"
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      has_node: ${{ steps.detect.outputs.has_node }}
      has_lock: ${{ steps.detect.outputs.has_lock }}
      has_python: ${{ steps.detect.outputs.has_python }}
      has_py_requirements: ${{ steps.detect.outputs.has_py_requirements }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        shell: bash
        run: |
          shopt -s nullglob
          has_node=false
          has_lock=false
          has_python=false
          has_py_requirements=false

          if [[ -f package.json ]]; then has_node=true; fi
          if [[ -f package-lock.json ]]; then has_lock=true; fi
          if compgen -G "requirements*.txt" > /dev/null || [[ -f pyproject.toml ]] || [[ -f setup.py ]]; then has_python=true; fi
          if compgen -G "requirements*.txt" > /dev/null; then has_py_requirements=true; fi

          {
            echo "has_node=$has_node"
            echo "has_lock=$has_lock"
            echo "has_python=$has_python"
            echo "has_py_requirements=$has_py_requirements"
          } >> "$GITHUB_OUTPUT"

  codeql:
    name: CodeQL
    needs: detect
    if: needs.detect.outputs.has_node == 'true' || needs.detect.outputs.has_python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ join(fromJson('["javascript","python"]'), ',') }}
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Analyze
        uses: github/codeql-action/analyze@v3

  dependency_scan:
    name: Dependency scan
    needs: detect
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - name: npm audit
        if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
        run: |
          npm ci --prefer-offline
          npm audit --audit-level=high --omit=dev || true
      - name: Setup Python
        if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            requirements*.txt
      - name: pip-audit
        if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-audit
          pip-audit -r requirements.txt || true
          if [[ -f requirements-dev.txt ]]; then pip-audit -r requirements-dev.txt || true; fi

  secret_scan:
    name: Secret scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --no-git --redact

  container_scan:
    name: Container/FS scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@v0.14.0
        with:
          scan-type: fs
          ignore-unfixed: true
          format: table
          severity: HIGH,CRITICAL
          exit-code: "1"

  sbom:
    name: SBOM (Syft)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          output-file: sbom-spdx.json
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom-spdx.json
