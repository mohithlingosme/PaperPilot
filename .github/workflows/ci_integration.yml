# Integration: push to main/develop or manual dispatch; spins up docker compose (Postgres/Redis/MinIO), runs migrations, API + worker integration tests, uploads logs on failure; caches deps and skips when stack missing.
name: Integration

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      has_node: ${{ steps.detect.outputs.has_node }}
      has_lock: ${{ steps.detect.outputs.has_lock }}
      has_python: ${{ steps.detect.outputs.has_python }}
      has_py_requirements: ${{ steps.detect.outputs.has_py_requirements }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        shell: bash
        run: |
          shopt -s nullglob
          has_node=false
          has_lock=false
          has_python=false
          has_py_requirements=false

          if [[ -f package.json ]]; then has_node=true; fi
          if [[ -f package-lock.json ]]; then has_lock=true; fi
          if compgen -G "requirements*.txt" > /dev/null || [[ -f pyproject.toml ]] || [[ -f setup.py ]]; then has_python=true; fi
          if compgen -G "requirements*.txt" > /dev/null; then has_py_requirements=true; fi

          {
            echo "has_node=$has_node"
            echo "has_lock=$has_lock"
            echo "has_python=$has_python"
            echo "has_py_requirements=$has_py_requirements"
          } >> "$GITHUB_OUTPUT"

  integration_tests_api:
    name: API integration tests
    needs: detect
    if: (needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true') || (needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true')
    runs-on: ubuntu-latest
    env:
      COMPOSE_FILE: infra/ci/docker-compose.ci.yml
    steps:
      - uses: actions/checkout@v4
      - name: Start services
        run: docker compose -f "$COMPOSE_FILE" up -d
      - name: Wait for services
        run: |
          until docker exec paperpilot_postgres pg_isready -U paperpilot; do sleep 2; done
          until docker exec paperpilot_redis redis-cli ping; do sleep 2; done
      - name: Node setup
        if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install Node deps
        if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
        run: npm ci --prefer-offline
      - name: Python setup
        if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            requirements*.txt
      - name: Install Python deps
        if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt || true
          if [[ -f requirements-dev.txt ]]; then python -m pip install -r requirements-dev.txt || true; fi
      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://paperpilot:paperpilot@localhost:5432/paperpilot' }}
        run: |
          npm run migrate --if-present || true
          if command -v alembic >/dev/null 2>&1; then alembic upgrade head; else echo "No DB migration tool configured; skipping."; fi
      - name: Integration tests
        run: |
          npm run test:integration --if-present || true
          if command -v pytest >/dev/null 2>&1; then pytest -q tests/integration || echo "No Python integration tests."; fi
      - name: Collect logs
        if: failure()
        run: docker compose -f "$COMPOSE_FILE" logs --no-color > integration-services.log
      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-services-logs
          path: integration-services.log
      - name: Shutdown
        if: always()
        run: docker compose -f "$COMPOSE_FILE" down -v

  integration_tests_workers:
    name: Worker integration tests
    needs: detect
    if: (needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true') || (needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true')
    runs-on: ubuntu-latest
    env:
      COMPOSE_FILE: infra/ci/docker-compose.ci.yml
    steps:
      - uses: actions/checkout@v4
      - name: Start services
        run: docker compose -f "$COMPOSE_FILE" up -d
      - name: Wait for services
        run: |
          until docker exec paperpilot_postgres pg_isready -U paperpilot; do sleep 2; done
          until docker exec paperpilot_redis redis-cli ping; do sleep 2; done
      - name: Node setup
        if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install Node deps
        if: needs.detect.outputs.has_node == 'true' && needs.detect.outputs.has_lock == 'true'
        run: npm ci --prefer-offline
      - name: Python setup
        if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            requirements*.txt
      - name: Install Python deps
        if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_py_requirements == 'true'
        run: |
          python -m pip install -r requirements.txt || true
          if [[ -f requirements-dev.txt ]]; then python -m pip install -r requirements-dev.txt || true; fi
      - name: Worker integration tests
        run: |
          npm run test:integration:worker --if-present || true
          if command -v pytest >/dev/null 2>&1; then pytest -q tests/workers || echo "No Python worker tests."; fi
      - name: Collect logs
        if: failure()
        run: docker compose -f "$COMPOSE_FILE" logs --no-color > worker-services.log
      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: worker-services-logs
          path: worker-services.log
      - name: Shutdown
        if: always()
        run: docker compose -f "$COMPOSE_FILE" down -v
